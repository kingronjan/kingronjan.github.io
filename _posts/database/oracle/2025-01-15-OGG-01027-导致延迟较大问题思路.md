---
categories:
- database
- oracle
date: 2025-01-15 22:11 +0800
id: c45a9abf-d8eb-4b95-af8d-64e674481c74
layout: post
tags:
- database
- oracle
title: OGG-01027 导致延迟较大问题思路
---

### 问题现象

日志中出现 OGG-01027 告警：

```
2020-10-30T18:10:08.469BEIST WARNING OGG-01027 Long Running Transaction: XID 993.6.69598, Items 1,Extract EX0123, Redo Thread 1, SCN 3918.1906392113 (16829588257841),Redo Seq #631053, Redo RBA 506349584.
```

通过 `INFO` 可以看到进程延迟很大：

```
ggsci> info EX0123
Lag at Chkpt: 155:17:01
```



### 排查思路

##### 查看数据库有无长事务

```sql
sql> select
	a.sid,
	a.serial#,
	a.username,
	b.addr,
	b.USED_UBLK,
	b.USED_UREC,
	b.START_TIME,
	b.xidusn,
	b.XIDSLOT, 
	b.xidsqn
from
	v$transaction b, 
	v$session a
where b.addr in (select a.taddr from v$session a where a.sid = '') and b.addr=a.taddr 
order by start_time
```

如果有的话需要及时提交。



##### 查看正在处理的未提交的事务

OGG 语法为：

```
send extract <进程名>, showtrans [thread n] [count n]
```

如：

```
ggsci> send extract EX0123, showtrans

------------------------------------
XID:			0.14.13.18652286
Items:			0
Extract:		EX0123
Redo Thread:	1
Start Time:		2025-01-08 T 09:13:41.0002
SCN:		    4436.1276535842(19053751460898)
Redo Seq:		1036794
Redo RBA:		719467324
Status:			Running 

...
```

可以看到有好几条未执行的事务，另外也可以通过下面的命令查看当前正在处理的事务：

```sql
ggsci> send extract EX0123, status
```

根据 goldengate 官方文档， 如果 Items 列为 0，即表示此事务不是 goldengate 抽取进程需要的，可以进行跳过，到这里其实跳过就可以了。

另外可以通过以下配置让 OGG 自动跳过空事务：

```
WARNLONGTRANS 2h, CHECKINTERVAL 10m, skipemptytrans
```



##### 使用 logminer 对事务进行日志挖掘，定位问题 SQL

如果排查时事务已不存在于内存中，可以通过 logminer 挖掘归档日志，定位相关的 SQL，具体操作如下：

1. 查看归档日志的文件路径

   可以根据 `showtrans` 或 `info <exgroup>, showch` 命令查看当前抽取的 `redo seq`

   ```sql
   sql> SELECT THREAD#, SEQUENCE#, NAME, FIRST_CHANGE#, NEXT_CHANGE#, STATUS
   	FROM V$ARCHIVED_LOG
   	WHERE FIRST_CHANGE# <= 21489950152
   	AND NEXT_CHANGE# >= 21489950152
   	AND STATUS = 'A';
   ```

   示例查询结果：

   ```
   
   THREAD# SEQUENCE# NAME                                        FIRST_CHANGE#     NEXT_CHANGE# STATUS
   ------- --------- ---------------------------------------- ---------------- ---------------- ----------
         1       377 +FRADG/honor/archivelog/2022_05_07/threa      21489950070      21489950244 A
                     d_1_seq_377.390.1104057109
   ```

2. 根据 name 建立 logminer:

   ```sql
   BEGIN
   
   dbms_logmnr.add_logfile(logfilename=>'+FRADG/honor/archivelog/2022_05_07/thread_1_seq_377.390.1104057109',options=>dbms_logmnr.NEW);
   
   END;
   
   /
   ```

3. 启用 logminer

   ```sql
   EXECUTE DBMS_LOGMNR.START_LOGMNR(OPTIONS => DBMS_LOGMNR.DICT_FROM_ONLINE_CATALOG);
   ```

4. 查看 XID  对应的 SQL

   ```sql
   -- 以 XID=138.29.311639792 为例
   sql> SELECT SESSION#,SERIAL#,sql_redo,XIDUSN,XIDSLT,XIDSQN  
   	FROM v$logmnr_contents where XIDUSN='138' and XIDSLT='29' and XIDSQN='311639792';
   ```

   示例结果：

   ```
   SESSION#   SERIAL#  sql_redo  					    XIDUSN XIDSLT  XIDSQN
   --------   -------  ------------------------------ 	  ----  ------  ----------------
    5378       9303    update "USER_1"."TABLE_A" set ...  138   29     311639792
   ```

5. 结束 logminer

   ```sql
   EXECUTE dbms_logmnr.END_LOGMNR;  
   ```

   

##### 跳过正在处理的事务

如果有必要，可以跳过当前进程正在处理的事务，根据 goldengate 官方文档， 如果 showtrans 命令列出的 Items 列为 0，即表示此事务不是 goldengate 抽取进程需要的，可以进行跳过，其他情况则需要根绝实际情况判断。

可以通过以下命令跳过：

```
# 0.14.13.18652286 即为上面结果中的 XID
ggsci> send extract EX0123, skiptrans 0.14.13.18652286
```

如果不希望弹出确认对话，可以在后面加上 FORCE 关键字：

```
ggsci> send extract EX0123, skiptrans 0.14.13.18652286 force
```

使用后，如果还想要停止进程，至少需要等待 5 分钟。

另外需要注意的是：要使用 skiptrans，指定的事务必须是 showtrans 列表中最旧的事务。

除了 skiptrans 外，也可以使用 forcetrans 强制认为该事务已提交。



### 参考

1. [Oracle GoldenGate (OGG)——OGG运维手册 - 拓扑园](https://www.topunix.com/post-607.html "Oracle GoldenGate (OGG)——OGG运维手册 - 拓扑园")
2. [查看OGG当前正在处理的事物_oracle ogg查看事物-CSDN博客](https://blog.csdn.net/weixin_44524950/article/details/86483585 "查看OGG当前正在处理的事物_oracle ogg查看事物-CSDN博客")
3. [OGG集成抽取模式丢失归档处理_ITPUB博客](https://blog.itpub.net/31439444/viewspace-2892888/ "OGG集成抽取模式丢失归档处理_ITPUB博客")
4. [OGG数据同步异常问题总结 - 墨天轮](https://www.modb.pro/db/40810 "OGG数据同步异常问题总结 - 墨天轮")
5. [大事务导致的OGG抽取进程每天7：39定时延时，运行极其缓慢_ITPUB博客](https://blog.itpub.net/69996316/viewspace-2936710/ "大事务导致的OGG抽取进程每天7：39定时延时，运行极其缓慢_ITPUB博客")
6. [SEND EXTRACT](https://docs.oracle.com/en/middleware/goldengate/core/19.1/gclir/send-extract.html "SEND EXTRACT")